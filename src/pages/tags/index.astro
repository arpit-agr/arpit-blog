---
import { loadAllEntries } from '@utils/loadAllEntries';
import BaseLayout from '@layouts/BaseLayout.astro';
import BannerText from '@components/BannerText.astro';
import SiteHeader from '@components/SiteHeader.astro';
import Aside from '@components/Aside.astro';
import FeedHeader from '@components/FeedHeader.astro';
import { TAGS_TITLE, TAGS_DESCRIPTION } from 'src/consts';
import { slug } from 'github-slugger';

const allEntries = await loadAllEntries();

// Build Map: tag → count
const tagCountMap = new Map();
for (const entry of allEntries) {
	const tags = entry.data.tags || [];
	for (const tag of tags) {
		tagCountMap.set(tag, (tagCountMap.get(tag) || 0) + 1);
	}
}

// Convert to array and sort alphabetically or by count (your choice)
const tagItems = [...tagCountMap.entries()].toSorted(); // DESC by count

// Get min + max
const counts = tagItems.map(([, c]) => c);
const min = Math.min(...counts);
const max = Math.max(...counts);

// Map a count to a “step” class (0 → 3)
function getStepClass(count: number) {
	if (min === max) return 'text-step-1'; // all equal

	const t = (count - min) / (max - min); // normalize 0 → 1

	// choose one: 4 levels
	if (t > 0.75) return 'text-step-6 leading-tight';
	if (t > 0.5) return 'text-step-4 leading-snug';
	if (t > 0.25) return 'text-step-2';
	return '';
}
---

<BaseLayout
	bodyClass="tag-page"
	pageTitle={TAGS_TITLE}
	pageDesc={TAGS_DESCRIPTION}
>
	<BannerText />
	<div class="page">
		<div>
			<SiteHeader />
			<main id="main">
				<FeedHeader
					isVisuallyHidden={false}
					sectionTitle="Tags"
					sectionDesc="Browse all tags used across my notes, articles, and links."
				/>
				<div class="center p-space-m">
					<ul class="multi-col flow align-self-stretch" role="list">
						{
							tagItems.map(([tag, count]) => (
								<li class:list={[getStepClass(count)]}>
									<a href={`/tags/${slug(tag)}/`}>{tag}</a>
									<span>({count})</span>
								</li>
							))
						}
					</ul>
				</div>
			</main>
		</div>
		<Aside />
	</div>
</BaseLayout>
