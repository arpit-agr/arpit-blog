---
import { loadAllEntries } from '@utils/loadAllEntries';
import BaseLayout from '@layouts/BaseLayout.astro';
import BannerText from '@components/BannerText.astro';
import SiteHeader from '@components/SiteHeader.astro';
import FeedHeader from '@components/FeedHeader.astro';
import Aside from '@components/Aside.astro';
import { ARCHIVE_TITLE, ARCHIVE_DESCRIPTION } from 'src/consts';

// Load all entries (already sorted newest → oldest)
const allEntries = await loadAllEntries();

// Group by year → month
const archive = new Map();

for (const entry of allEntries) {
	const date = entry.data.pubDate;
	const year = date.getFullYear();
	const month = date.getMonth() + 1;
	const monthKey = String(month).padStart(2, '0');

	if (!archive.has(year)) archive.set(year, new Set());
	archive.get(year).add(monthKey);
}

// Convert to sorted structure
const years = Array.from(archive.keys()).sort((a, b) => b - a);
---

<BaseLayout
	bodyClass="archive-page"
	pageTitle={ARCHIVE_TITLE}
	pageDesc={ARCHIVE_DESCRIPTION}
>
	<BannerText />
	<div class="page">
		<div>
			<SiteHeader />
			<main id="main">
				<FeedHeader
					isVisuallyHidden={false}
					sectionTitle="Archive"
					sectionDesc="Browse all entries grouped by year and month."
				/>
				<div class="center pi-space-m">
					<div class="archive-list align-self-stretch">
						{
							years.map((year) => (
								<section class="align-self-stretch">
									<h2>{year}</h2>
									<ul role="list">
										{Array.from(archive.get(year))
											.sort((a, b) => Number(b) - Number(a)) // descending months
											.map((month) => {
												const label = new Intl.DateTimeFormat('en-IN', {
													month: 'long',
												}).format(new Date(year, Number(month) - 1));
												return (
													<li>
														<a href={`/archive/${year}/${month}/`}>
															<span>{label}</span>
															<span class="visually-hidden">{year}</span>
														</a>
													</li>
												);
											})}
									</ul>
								</section>
							))
						}
					</div>
				</div>
			</main>
		</div>
		<Aside />
	</div>
</BaseLayout>
