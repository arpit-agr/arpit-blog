---
import { loadAllEntries } from '@utils/loadAllEntries';
import BaseLayout from '@layouts/BaseLayout.astro';
import BannerText from '@components/BannerText.astro';
import SiteHeader from '@components/SiteHeader.astro';
import FeedHeader from '@components/FeedHeader.astro';
import Aside from '@components/Aside.astro';
import { ARCHIVE_TITLE, ARCHIVE_DESCRIPTION } from 'src/consts';

// Load all entries (already sorted newest → oldest)
const allEntries = await loadAllEntries();

// Group by year → month
const archive = new Map();

for (const entry of allEntries) {
	const date = entry.data.pubDate;
	const year = date.getFullYear();
	const month = date.getMonth() + 1;
	const monthKey = String(month).padStart(2, '0');

	if (!archive.has(year)) archive.set(year, new Set());
	archive.get(year).add(monthKey);
}

// Convert to sorted structure
const years = Array.from(archive.keys()).sort((a, b) => b - a);
---

<BaseLayout pageTitle={ARCHIVE_TITLE} pageDesc={ARCHIVE_DESCRIPTION}>
	<BannerText />
	<div class="page">
		<SiteHeader />
		<div class="page-inner">
			<main id="main">
				<FeedHeader
					isVisuallyHidden={false}
					sectionTitle="Archive"
					sectionDesc="Browse all my notes, articles, and links, grouped by year and month."
				/>
				<div class="center p-space-m">
					<div
						class="grid align-self-stretch"
						style="--grid-min-item-size: 25ch;"
					>
						{
							years.map((year) => (
								<section class="flow flow-space-s align-self-stretch">
									<h2>{year}</h2>
									<ul>
										{Array.from(archive.get(year))
											.sort((a, b) => Number(b) - Number(a)) // descending months
											.map((month) => {
												const label = new Date(
													year,
													Number(month) - 1,
												).toLocaleString('en-IN', {
													month: 'long',
													year: 'numeric',
												});
												return (
													<li>
														<a href={`/archive/${year}/${month}/`}>{label}</a>
													</li>
												);
											})}
									</ul>
								</section>
							))
						}
					</div>
				</div>
			</main>
			<Aside />
		</div>
	</div>
</BaseLayout>
