---
import type { GetStaticPaths } from 'astro';
import type { CollectionEntry } from 'astro:content';
import { loadAndFormatCollection } from '@utils/collection';
import { render } from 'astro:content';

import BaseLayout from '@layouts/BaseLayout.astro';
import BannerText from '@components/BannerText.astro';
import SiteHeader from '@components/SiteHeader.astro';
import FeedHeader from '@components/FeedHeader.astro';
import PaginatedEntries from '@components/PaginatedEntries.astro';
import Aside from '@components/Aside.astro';
import CurrentlyReading from '@components/CurrentlyReading.astro';
import { ARTICLES_TITLE, ARTICLES_DESCRIPTION } from 'src/consts';

type ArticleEntry = CollectionEntry<'articles'>;

export const getStaticPaths = (async ({ paginate }) => {
	const allEntries = (await loadAndFormatCollection(
		'articles',
	)) as ArticleEntry[];
	return paginate(allEntries, { pageSize: 20 });
}) satisfies GetStaticPaths;

const { page } = Astro.props;
const entries = await Promise.all(
	page.data.map(async (entry) => {
		const { Content } = await render(entry);
		return { ...entry, Content };
	}),
);

const pageTitle =
	page.currentPage > 1
		? `Page ${page.currentPage} - ${ARTICLES_TITLE}`
		: ARTICLES_TITLE;
const sectionDesc = page.currentPage > 1 ? `Page ${page.currentPage}` : '';
---

<BaseLayout
	bodyClass="homepage"
	{pageTitle}
	pageDesc={ARTICLES_DESCRIPTION}
	ogType="website"
>
	<BannerText />
	<div class="page">
		<div>
			<div class="page-inner">
				<div>
					<SiteHeader />
					<main id="main">
						<FeedHeader
							isVisuallyHidden={false}
							sectionTitle="Articles"
							{sectionDesc}
						/>
						<PaginatedEntries page={page} entries={entries} />
					</main>
				</div>
				<Aside>
					<CurrentlyReading />
				</Aside>
			</div>
		</div>
	</div>
</BaseLayout>
