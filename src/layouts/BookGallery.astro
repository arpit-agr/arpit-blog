---
import BaseLayout from '@layouts/BaseLayout.astro';
import BookCover from '@components/BookCover.astro';

import { getCollection } from 'astro:content';
import { slug } from 'github-slugger';

type Props = {
	pageTitle: string;
	pageDesc: string;
	sectionDesc: string;
	filterStatuses: string[];
};

const { pageTitle, pageDesc, sectionDesc, filterStatuses } = Astro.props;

// Determine which page we're on
const path = Astro.url.pathname;
const isLibraryPage = path.includes('/library/');

// Fetch and filter books
const books = await getCollection('books', ({ data }) =>
	filterStatuses.includes(data.status),
);

const uniqueTags = [...new Set(books.map((entry) => entry.data.tags).flat())];
---

<BaseLayout bodyClass="book-gallery" pageTitle={pageTitle} pageDesc={pageDesc}>
	<div class="flow wrapper pb-space-l">
		<header class="stack">
			<div class="nav-item heading-3">
				<a href="/">Home</a>
			</div>
			<div class="flow">
				<div class="heading-group cluster gap-xs">
					{
						isLibraryPage ? (
							<Fragment>
								<h1>Library</h1>
								<div class="separator" aria-hidden="true" />
								<a class="heading-1 text-box-trim" href="/antilibrary/">
									<span>Antilibrary</span>
								</a>
							</Fragment>
						) : (
							<Fragment>
								<a class="heading-1 text-box-trim" href="/library/">
									<span>Library</span>
								</a>
								<div class="separator" aria-hidden="true" />
								<h1>Antilibrary</h1>
							</Fragment>
						)
					}
				</div>
				<p class="text-step-1 text-box-trim">
					{sectionDesc}
				</p>
			</div>
		</header>
		<main class="flow" id="main">
			<fieldset class="book-filters flow" disabled>
				<legend class="heading-4">Filter:</legend>
				<div class="cluster">
					<div class="btn cluster gap-0">
						<input name="filter" id="all" type="radio" value="all" checked="" />
						<label class="font-medium text-box-trim" for="all">All</label>
					</div>
					{
						uniqueTags.map((tag) => {
							const tagID = `tag-${slug(tag)}`;
							return (
								<div class="btn cluster gap-0">
									<input name="filter" id={tagID} type="radio" value={tag} />
									<label class="font-medium text-box-trim" for={tagID}>
										{tag}
									</label>
								</div>
							);
						})
					}
				</div>
			</fieldset>
			<h2 id="books-results-count" aria-live="polite">
				{books.length} books
			</h2>
			<ul class="book-list grid" role="list">
				{
					books.map((item, index) => {
						const viewTransitionName = `book-${item.id}`;
						const randomNum = Math.random() * (0.5 - -0.5) - 0.5;
						const rotationAngle = `calc(${randomNum} * 1deg)`;
						return (
							<li
								data-tags={item.data.tags}
								style={{
									'view-transition-name': viewTransitionName,
								}}
							>
								<div
									class="book-wrapper"
									style={{
										'--dominant-color': item.data.dominantColor,
										rotate: rotationAngle,
									}}
								>
									<div>
										<div class="cover">
											<BookCover
												imagePath={item.data.cover}
												widths={[315, 630]}
												priority={index < 12}
												sizes="(width < 21.5rem) 100vw, (width < 32.125rem) 50vw, (width < 43rem) 33vw, (width <= 54.125rem) 25vw, (width < 65.625rem) 20vw, 16.67vw"
											/>
										</div>
										<div class="spine" />
									</div>
								</div>
								<div class="stack gap-2xs">
									<h2 class="heading-3 leading-snug">{item.data.title}</h2>
									<p class="text-step--1">{item.data.author}</p>
								</div>
							</li>
						);
					})
				}
			</ul>
		</main>
	</div>
</BaseLayout>

<script src="/src/scripts/book-filters.js"></script>
